<!doctype html>
    <html lang="en-US" id="template-post" class="base">
        <head>
        
        <script defer data-domain="fightwithtools.dev" src="https://plausible.io/js/plausible.js"></script>
        <link rel="alternate" type="application/rss+xml" title="Fight With Tools: A Dev Blog RSS" href="https://fightwithtools.dev/rss/" />
    	<link rel="alternate" type="application/atom+xml" title="Fight With Tools: A Dev Blog Feed" href="https://fightwithtools.dev/feed/" />
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Day 18: Ok, I used it a whole bunch. Now time to adjust.</title>
        
            <!-- Sub Template: post -->
        
        
            <link rel="preload" as="font">
            <link href="https://fightwithtools.dev/assets/prism-okaidia.css" rel="preload" as="style" />
            <link href="https://fightwithtools.dev/assets/prism-okaidia.css" rel="stylesheet" />
            <!-- <link rel="stylesheet" href="https://fightwithtools.dev/assets/css/style.css?v=5882427119" /> -->
            <link rel="stylesheet" href="https://fightwithtools.dev/assets/css/style.css?v=5882427119" id=""></link>

            
                <!-- <link rel="stylesheet" href="https://fightwithtools.dev/assets/css/template-post.css?v=5882427119" /> -->
                <link rel="stylesheet" href="https://fightwithtools.dev/assets/css/template-post.css?v=5882427119" id=""></link>

            
            <!-- Build Revision: 5882427119 & Sha: 7fdbfd292007c8015754912b0dd5bac26efc334b -->
            <script src="https://fightwithtools.dev/assets/js/scale.fix.js" async></script>
            <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
            <!--[if lt IE 9]>
                <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
            <![endif]-->
        
        
            <!-- The Author meta propagates the byline in a number of social networks -->
<meta name="author" content="Aram Zucker-Scharff" />

<meta property="og:title"
    content="Day 18: Ok, I used it a whole bunch. Now time to adjust.">

<meta property="og:description"
    content="Better crawling, better tools for the static site generator.">


<meta property="og:url"
    content="https://fightwithtools.dev/posts/projects/context-pages/day-18-adjusting-from-use/" />

<meta property="og:site_name" content="Fight With Tools: A Dev Blog" />

<meta property="og:locale" content="en_US" />

<meta name="twitter:site" content="@chronotope" />

<meta name="twitter:description" content="Better crawling, better tools for the static site generator." />

<meta name="description" content="Better crawling, better tools for the static site generator.">

<!-- I prefer the summary_large_image Twitter card for posts. -->
<meta name="twitter:card" content="summary_large_image" />
<!-- You, you're the creator. -->
<meta name="twitter:creator" content="@chronotope" />
<!-- This property is for the article title, not site title. -->
<meta name="twitter:title" content="Day 18: Ok, I used it a whole bunch. Now time to adjust." />



<meta property="og:image" content="https://fightwithtools.dev/img/radial_crosshair.jpg" />
<meta name="twitter:image" content="https://fightwithtools.dev/img/radial_crosshair.jpg" />




    <!-- Article specific OG data -->
    <!-- The OG:Type dictates a number of other tags on posts. -->
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content="Mon, 02 May 2022 02:59:43 GMT" />

    <!-- page.modified isn't a natural Jekyll property, but it can be added. -->
    

    <!-- Here my author and publisher tags are the same (yay self-publishing) -->
    <meta property="article:author" content="http://facebook.com/aramzs" />
    <!-- But if your site has its own page, this is where to put it. -->
    <meta property="article:publisher" content="https://www.facebook.com/aramzs" />

    
    <!-- Article section isn't a required property, but it can be good to have -->
    <meta property="article:section" content="Context Pages" />
    

    
        <!-- I use the page.categories property for OG tags. -->
        
        <meta property="article:tag" content="posts" />
        
        <meta property="article:tag" content="projects" />
        
        <meta property="article:tag" content="Node" />
        
        <meta property="article:tag" content="WiP" />
        
        <meta property="article:tag" content="archiving" />
        
        <meta property="article:tag" content="fetch" />
        
        <meta property="article:tag" content="User Agents" />
        
        <meta property="article:tag" content="scraping" />
        
        <meta name="keywords" content="posts, projects, Node, WiP, archiving, fetch, User Agents, scraping">
    



            <script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "Blog",
        "url": "https://fightwithtools.dev/posts/projects/context-pages/day-18-adjusting-from-use/",
        "headline": "Day 18: Ok, I used it a whole bunch. Now time to adjust.",
        "about": "Better crawling, better tools for the static site generator.",
        "image": [
            "https://41.media.tumblr.com/709bb3c371b9924add351bfe3386e946/tumblr_nxdq8uFdx81qzocgko1_1280.jpg"
        ],
        "isAccessibleForFree": "True",
        "isPartOf": {
            "@type": ["CreativeWork", "Product"],
            "name": "Fight With Tools",
            "productID": "fightwithtools.dev"
        },
        "discussionUrl": "https://twitter.com/search?q=to%3AChronotope%20%23dev&src=typed_query&f=top",
        "author": {
    "@type": "Person",
    "name": {
        "@type": "PronounceableText",
        "inLanguage": "en-US",
        "textValue": "Aram Zucker-Scharff",
        "speechToTextMarkup": "IPA",
        "phoneticText": "/ˌæ.ɹəm ˈt͡sʊ.kɚ 'ʃɑɹf/"
    },
    "description": "Aram Zucker-Scharff is Lead Privacy Engineer at The Washington Post, lead dev for PressForward and a consultant. Tech solutions for journo problems.",
    "disambiguatingDescription": "A media-focused developer and strategist.",
    "sameAs": "http://aramzs.github.io/aramzs/",
    "image": {
        "@type": "ImageObject",
        "url": "https://raw.githubusercontent.com/AramZS/aramzs.github.io/master/_includes/Aram-Zucker-Scharff-square.jpg"
    },
    "givenName": "Aram",
    "familyName": "Zucker-Scharff",
    "alternateName": "AramZS",
    "publishingPrinciples": "http://aramzs.github.io/about/"
}, 
        "editor": {
    "@type": "Person",
    "name": {
        "@type": "PronounceableText",
        "inLanguage": "en-US",
        "textValue": "Aram Zucker-Scharff",
        "speechToTextMarkup": "IPA",
        "phoneticText": "/ˌæ.ɹəm ˈt͡sʊ.kɚ 'ʃɑɹf/"
    },
    "description": "Aram Zucker-Scharff is Lead Privacy Engineer at The Washington Post, lead dev for PressForward and a consultant. Tech solutions for journo problems.",
    "disambiguatingDescription": "A media-focused developer and strategist.",
    "sameAs": "http://aramzs.github.io/aramzs/",
    "image": {
        "@type": "ImageObject",
        "url": "https://raw.githubusercontent.com/AramZS/aramzs.github.io/master/_includes/Aram-Zucker-Scharff-square.jpg"
    },
    "givenName": "Aram",
    "familyName": "Zucker-Scharff",
    "alternateName": "AramZS",
    "publishingPrinciples": "http://aramzs.github.io/about/"
},
        "inLanguage": "en-US",
        "license": "http://creativecommons.org/licenses/by-sa/4.0/",
        "additionalType": "CreativeWork",
        "alternateName": "Fight With Tools Dev",
        "publisher": {
            "@type": "Organization",
            "name": "Fight With Tools",
            "description": "A site discussing how to imagine, build, analyze and use cool code and web tools. Better websites, better stories, better developers. Technology won't save the world, but you can.",
            "sameAs": "https://fightwithtools.dev/",
            "logo": {
                "@type": "ImageObject",
                "url": "https://41.media.tumblr.com/709bb3c371b9924add351bfe3386e946/tumblr_nxdq8uFdx81qzocgko1_1280.jpg"
            },
            "publishingPrinciples": "http://aramzs.github.io/about/"
        }
    }
</script>

        
        
        
<link rel="canonical" href="https://fightwithtools.dev/posts/projects/context-pages/day-18-adjusting-from-use/" />

        </head>
        <body itemscope itemtype="https://schema.org/Blog">
            <div class="wrapper">
                <header>
                    
                        
                            <div id="site-name-subhead">
                                <a href="https://fightwithtools.dev">Fight With Tools: A Dev Blog</a>
                                
                                    > <a id="project-link" href="https://fightwithtools.dev/projects/context-pages">Context Pages</a>
                                
                            </div>
                        
                        
                            <!-- post mode -->
                            <time>Mon May 02 2022</time>
                            <!-- front matter dates made in format at https://yaml.org/type/timestamp.html -->
                        
                        
                            <!-- projects mode -->
                        
                        <h1 class="header">
                            Day 18: Ok, I used it a whole bunch. Now time to adjust.
                        </h1>
                        
                        
                    
                    
    <h5 itemprop="author" itemscope itemtype="https://schema.org/Person">
    <link itemprop="sameAs" href="http://aramzs.github.io/aramzs/" />
    By <span itemprop="name"><a href="http://aramzs.github.io/aramzs/" target="_blank">Aram Zucker-Scharff</a></span>
</h5>

                </header>
                <main>
                    
    <section id="precontent">
        <aside id="toc-container">
            <div id="toc-container__inner">
                <h2>Contents</h2>
                <nav class="toc">
        <ol><li><a href="#project-scope-and-todos">Project Scope and ToDos</a></li><li><a href="#day-18">Day 18</a><ol><li><a href="#get-better-scraping-results">Get better scraping results</a></li><li><a href="#embed-build-process">Embed Build Process</a></li><li><a href="#unit-tests-now-twitter-embeds-later">Unit Tests Now, Twitter Embeds Later</a></li></ol></li></ol></nav>
            </div>
        </aside>
        <div id="post-description">Better crawling, better tools for the static site generator.</div>

        

    </section>

                    <section id="maincontent" class="maincontent">
                    
                        <h2 id="project-scope-and-todos" tabindex="-1">Project Scope and ToDos</h2>
<ol>
<li>Take a link and turn it into an oEmbed/Open Graph style share card</li>
<li>Take a link and archive it in the most reliable way</li>
<li>When the link is a tweet, display the tweet but also the whole tweet thread.</li>
<li>When the link is a tweet, archive the tweets, and display them if the live ones are not available.</li>
<li>Capture any embedded retweets in the thread. Capture their thread if one exists</li>
<li>Capture any links in the Tweet</li>
<li>Create the process as an abstract function that returns the data in a savable way</li>
</ol>
<ul class="task-list">
<li class="task-list-item"><input disabled="true" type="checkbox" checked="true" class="markdown-todo"></input> Archive links on <a href="http://Archive.org" target="_blank">Archive.org</a> and save the resulting archival links</li>
<li class="task-list-item"><input disabled="true" type="checkbox" checked="true" class="markdown-todo"></input> Create link IDs that can be used to cache related content</li>
<li class="task-list-item"><input disabled="true" type="checkbox" class="markdown-todo"></input> Integrate it into the site to be able to make context pages here.</li>
<li class="task-list-item"><input disabled="true" type="checkbox" class="markdown-todo"></input> Check if a link is still available at build time and rebuild the block with links to an archived link</li>
<li class="task-list-item"><input disabled="true" type="checkbox" class="markdown-todo"></input> Use v1 Twitter API to get Gifs and videos</li>
<li class="task-list-item"><input disabled="true" type="checkbox" class="markdown-todo"></input> Pull Twitter images into Eleventy archive.</li>
<li class="task-list-item"><input disabled="true" type="checkbox" class="markdown-todo"></input> Add YouTube DL tool.</li>
<li class="task-list-item"><input disabled="true" type="checkbox" class="markdown-todo"></input> Use <a href="https://github.com/oduwsdl/archivenow" target="_blank">https://github.com/oduwsdl/archivenow</a>?</li>
<li class="task-list-item"><input disabled="true" type="checkbox" class="markdown-todo"></input> Improve handoff to <a href="http://Archive.org" target="_blank">Archive.org</a> with <a href="https://twitter.com/Chronotope/status/1517116475601043456" target="_blank">various other methods</a>.</li>
<li class="task-list-item"><input disabled="true" type="checkbox" class="markdown-todo"></input> Contexter needs to read author objects out of Schema dot org JSON-LD blocks.</li>
<li class="task-list-item"><input disabled="true" type="checkbox" class="markdown-todo"></input> Fall back to use Puppeteer</li>
<li class="task-list-item"><input disabled="true" type="checkbox" class="markdown-todo"></input> Fall back to read the version on the Internet Archive</li>
<li class="task-list-item"><input disabled="true" type="checkbox" class="markdown-todo"></input> Do something better when the same link is in the text more than once.</li>
<li class="task-list-item"><input disabled="true" type="checkbox" class="markdown-todo"></input> Allow the user to override a link's metadata with a markdown file.</li>
</ul>
<h2 id="day-18" tabindex="-1">Day 18</h2>
<p>Ok, so I put this project through it's paces by using it over the last monthish. It's working surprisingly well, but I think there are a few issues. The first is that while the Facebook UA works most of the time, it doesn't always. So let's use the work I did in Backreads to try and up my chances of successfully getting a scrape using the standard means, even if I want to eventually drop a headless browser into this process.</p>
<p>I also want to set it up so that the static site generator does the actual build process instead of baking it into the JSON file. I think this process ends up being a little more compelex, but it will make creating updates easier and I think make the whole project more sustainable and easier to support.</p>
<h3 id="get-better-scraping-results" tabindex="-1">Get better scraping results</h3>
<p>Ok, so, when I was experimenting with <a href="https://github.com/AramZS/backreads/" target="_blank">Backreads</a> I found that the right User Agent really made a difference. So I'm going to bring over and clean up some of the logic I worked out there.</p>
<p>The first thing is to bring over a list of User Agents (or UAs) and give myself some tools to select which one to use. When working with Node Fetch before I found that particular URLs were more likely to respond with particular UAs. So I'll build a function to handle that selection process and store a few UAs that might be useful for scraping. I also want to have the option to exclude specific UAs when I've already tried them. Ok so:</p>
<p class="skip-link-graf">
<a href="#code-skip-day-18-adjusting-from-use-2" id="skip-to-code-skip-day-18-adjusting-from-use-2" class="skip-link">Skip code block ▼</a></p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> ua <span class="token operator">=</span><br>	<span class="token string">"facebookexternalhit/1.1 (+http://www.facebook.com/externalhit_uatext.php)"</span><span class="token punctuation">;</span><br><br><br><span class="token keyword">const</span> <span class="token function-variable function">selectUserAgent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">link<span class="token punctuation">,</span> shuffleExclude <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	<span class="token keyword">let</span> userAgent <span class="token operator">=</span> ua<span class="token punctuation">;</span><br>	<span class="token comment">// https://developers.whatismybrowser.com/useragents/explore/software_type_specific/?utm_source=whatismybrowsercom&amp;utm_medium=internal&amp;utm_campaign=breadcrumbs</span><br>	<span class="token comment">// https://user-agents.net/lookup</span><br>	<span class="token keyword">const</span> userAgents <span class="token operator">=</span> <span class="token punctuation">{</span><br>		windows<span class="token operator">:</span><br>			<span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) "</span> <span class="token operator">+</span><br>			<span class="token string">"AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149 "</span> <span class="token operator">+</span><br>			<span class="token string">"Safari/537.36"</span><span class="token punctuation">,</span><br>		osx14<span class="token operator">:</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/86.0.4240.198 Safari/537.36 OPR/72.0.3815.400"</span><span class="token punctuation">,</span><br>		firefox<span class="token operator">:</span><br>			<span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:83.0) Gecko/20100101 Firefox/83.0"</span><span class="token punctuation">,</span><br>		firefox99<span class="token operator">:</span><br>			<span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:99.0) Gecko/20100101 Firefox/99.0"</span><span class="token punctuation">,</span><br>		osx11<span class="token operator">:</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_2) AppleWebKit/601.3.9 (KHTML, like Gecko) Version/9.0.2 Safari/601.3.9"</span><span class="token punctuation">,</span><br>		baidu_ua<span class="token operator">:</span> <span class="token string">"Baiduspider+(+http://www.baidu.com/search/spider.htm)"</span><span class="token punctuation">,</span><br>		googlebot<span class="token operator">:</span> <span class="token string">"Googlebot/2.1 (+http://www.google.com/bot.html)"</span><span class="token punctuation">,</span><br>		modernGooglebot<span class="token operator">:</span><br>			<span class="token string">"UCWEB/2.0 (compatible; Googlebot/2.1; +google.com/bot.html)"</span><span class="token punctuation">,</span><br>		pythonRequests<span class="token operator">:</span> <span class="token string">"python-requests/2.23.0"</span><span class="token punctuation">,</span><br>		facebookRequests<span class="token operator">:</span><br>			<span class="token string">"facebookexternalhit/1.1 (+http://www.facebook.com/externalhit_uatext.php)"</span><span class="token punctuation">,</span><br>		lighthouse<span class="token operator">:</span><br>			<span class="token string">"Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko; Google Page Speed Insights) Chrome/41.0.2272.118 Safari/537.36"</span><span class="token punctuation">,</span><br>		osx15<span class="token operator">:</span> <span class="token string">"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:77.0) Gecko/20100101 Firefox/77.0"</span><span class="token punctuation">,</span><br>		linux<span class="token operator">:</span> <span class="token string">"Mozilla/5.0 (X11; Linux x86_64)"</span><span class="token punctuation">,</span><br>		mobileBrave<span class="token operator">:</span><br>			<span class="token string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.38 Safari/537.36 Brave/75"</span><span class="token punctuation">,</span><br>		feedReader<span class="token operator">:</span><br>			<span class="token string">"Feedspot/1.0 (+https://www.feedspot.com/fs/fetcher; like FeedFetcher-Google)"</span><span class="token punctuation">,</span><br>	<span class="token punctuation">}</span><span class="token punctuation">;</span><br>	<span class="token keyword">const</span> substackERx <span class="token operator">=</span> <span class="token function">RegExp</span><span class="token punctuation">(</span><span class="token string">"email.substack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">const</span> substackMGRx <span class="token operator">=</span> <span class="token function">RegExp</span><span class="token punctuation">(</span><span class="token string">"mg2.substack"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">const</span> washPostRx <span class="token operator">=</span> <span class="token function">RegExp</span><span class="token punctuation">(</span><span class="token string">"s2.washingtonpost.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">const</span> washPostStandardRx <span class="token operator">=</span> <span class="token function">RegExp</span><span class="token punctuation">(</span><span class="token string">"washingtonpost.com"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">const</span> archiveOrg <span class="token operator">=</span> <span class="token function">RegExp</span><span class="token punctuation">(</span><span class="token string">"archive.org"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>	<span class="token keyword">const</span> bbergLink <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">link\.mail\.bloombergbusiness\.com</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span><br>	<span class="token keyword">const</span> bberg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">bloomberg</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span><br>	<span class="token keyword">const</span> goLink <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">r\.g-omedia\.com</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span><br>	<span class="token keyword">const</span> logicLink <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">thelogic\.us12\.list-manage\.com</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">;</span><br><br>	<span class="token keyword">if</span> <span class="token punctuation">(</span>substackMGRx<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span> <span class="token operator">||</span> substackERx<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		userAgent <span class="token operator">=</span> userAgents<span class="token punctuation">.</span>baidu_ua<span class="token punctuation">;</span><br>	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>washPostRx<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		userAgent <span class="token operator">=</span> userAgents<span class="token punctuation">.</span>lighthouse<span class="token punctuation">;</span><br>	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>washPostStandardRx<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		userAgent <span class="token operator">=</span> userAgents<span class="token punctuation">.</span>lighthouse<span class="token punctuation">;</span><br>	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>bbergLink<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span> <span class="token operator">||</span> goLink<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span> <span class="token operator">||</span> bberg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		userAgent <span class="token operator">=</span> userAgents<span class="token punctuation">.</span>osx11<span class="token punctuation">;</span><br>	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>logicLink<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span> <span class="token operator">||</span> archiveOrg<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>link<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>		userAgent <span class="token operator">=</span> userAgents<span class="token punctuation">.</span>firefox<span class="token punctuation">;</span><br>	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>		<span class="token keyword">const</span> keys <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>userAgents<span class="token punctuation">)</span><span class="token punctuation">;</span><br>		<span class="token keyword">if</span> <span class="token punctuation">(</span>shuffleExclude<span class="token punctuation">)</span> <span class="token punctuation">{</span><br>			<span class="token keyword">var</span> index <span class="token operator">=</span> keys<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>shuffleExclude<span class="token punctuation">)</span><span class="token punctuation">;</span><br>			<span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">></span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>				keys<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>			<span class="token punctuation">}</span><br>		<span class="token punctuation">}</span><br>		userAgent <span class="token operator">=</span> keys<span class="token punctuation">[</span>Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> keys<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span><br>	<span class="token punctuation">}</span><br>	<span class="token keyword">return</span> userAgent<span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<p id="code-skip-day-18-adjusting-from-use-2">This structure should also allow me to add more UAs and more links that respond to them as I go forward and when the link isn't known to me I can just shuffle the User Agent list and pull a random UA from the set.</p>
<p>I also noticed an issue where a number of the URLs would hang on request for unclear reasons. I should set up a way to avoid that. Thankfully, this was <a href="https://github.com/AramZS/backreads/blob/main/lambdas/html-from-email/parsing-tools.js#L301" target="_blank">also something I developed</a> for the Backreads project.</p>
<p>I can set the timeout using the <a href="https://www.npmjs.com/package/abort-controller" target="_blank">AbortController</a> object.</p>
<p>Using this to set my fetch options with an abort signal should work and prevent future hanging of the process (hopefully!).</p>
<p class="skip-link-graf">
<a href="#code-skip-day-18-adjusting-from-use-1" id="skip-to-code-skip-day-18-adjusting-from-use-1" class="skip-link">Skip code block ▼</a></p>
<pre class="language-javascript"><code class="language-javascript"><span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token keyword">const</span> fetchTimeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span><br>	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Request timed out for"</span><span class="token punctuation">,</span> link<span class="token punctuation">,</span> userAgent<span class="token punctuation">)</span><span class="token punctuation">;</span><br>	controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>finalFetchOptions<span class="token punctuation">.</span>signal <span class="token operator">=</span> controller<span class="token punctuation">.</span>signal<span class="token punctuation">;</span></code></pre>
<p id="code-skip-day-18-adjusting-from-use-1">With this in hand I can also set up a retry process.</p>
<p><code>git commit -m &quot;Setting up UA rotation + retry&quot;</code></p>
<p>Ok, I can incorporate a better header into the Archives request. There is <a href="https://github.com/MaxBittker/nyt-first-said/blob/master/parsers/archive_bounce.py#L17" target="_blank">an option to download via the web archive</a> which might be worth exploring later.</p>
<p><code>git commit -m &quot;Fix request UA setup, add archiver improvements&quot;</code></p>
<h3 id="embed-build-process" tabindex="-1">Embed Build Process</h3>
<p>Ok, so now we should set up functions that can be accessible to the extending program so it can build it's own link blocks. We can also set it up so that the required setup script can be created only once by the subject site.</p>
<p><a target="_blank" href="https://github.com/AramZS/contexter/commit/f9fd14e5caf5d252b7966d916044e1b871e46745" class="git-commit-link"><code>git commit -am &quot;Set up functions that can be extended for other systems to make the link block themselves&quot;</code></a></p>
<p>Ok. While I'm in here I want to avoid situations like Bloomberg where I keep getting back context-less robot blocking pages. Let's set up a check for titles like those that aren't properly giving me status codes.</p>
<p><a target="_blank" href="https://github.com/AramZS/contexter/commit/ba8c72c3b142da938b7d9d82f7c5ca59682a2b9f" class="git-commit-link"><code>git commit -am &quot;Check titles for 404-style responses that don't have the right status codes.&quot;</code></a></p>
<h3 id="unit-tests-now-twitter-embeds-later" tabindex="-1">Unit Tests Now, Twitter Embeds Later</h3>
<p>The other thing I want to do is have better Twitter embeds. That means good styles and not relying on the Twitter scripts, which are pretty awful to load.</p>
<p>But now that I've taken the time to get the unit tests working, that'll have to be for another night.</p>
<p><a target="_blank" href="https://github.com/AramZS/contexter/commit/c51ebaa0f2c90f5d41b13779b4e68e3f36058c72" class="git-commit-link"><code>git commit -am &quot;Getting unit tests back working&quot;</code></a></p>

                    
                    </section>
                    <section id="postcontent">
                    
    
        
        
        <div class="pagination">
            <a href="/posts/projects/context-pages/day-17/" class="pagination-link cursor-pointer ">Previous Day</a>

            <a href="javascript:void(0)" class="pagination-link  disabled-link cursor-default">Next Day</a>
        </div>
    
    <div class="social-icons-block">
    <div class="a-social-icon">
        <a href="https://github.com/AramZS/" target="_blank">
            <svg role="img" viewBox="0 0 24 24" class="twitter-icon social-icon" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg>


<!-- https://simpleicons.org/?q=github -->

        </a>
    </div>
    <div class="a-social-icon">
        <a href="https://bit.ly/aramzs" target="_blank">
            <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>


<!-- https://simpleicons.org/?q=linked -->

        </a>
    </div>
    <div class="a-social-icon">
        <a href="https://twitter.com/Chronotope" target="_blank">
            <svg role="img" class="twitter-icon social-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Twitter</title><path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/></svg>

<!-- https://simpleicons.org/?q=tw -->

        </a>
    </div>
    
    <div class="a-social-icon">
        <a href="https://indieweb.social/@Chronotope" rel="me" target="_blank">
            <svg role="img" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><title>Mastodon</title><path d="M23.193 7.88c0-5.207-3.411-6.733-3.411-6.733C18.062.357 15.108.025 12.041 0h-.076c-3.069.025-6.02.357-7.74 1.147 0 0-3.412 1.526-3.412 6.732 0 1.193-.023 2.619.015 4.13.124 5.092.934 10.11 5.641 11.355 2.17.574 4.034.695 5.536.612 2.722-.15 4.25-.972 4.25-.972l-.09-1.975s-1.945.613-4.13.54c-2.165-.075-4.449-.234-4.799-2.892a5.5 5.5 0 0 1-.048-.745s2.125.52 4.818.643c1.646.075 3.19-.097 4.758-.283 3.007-.359 5.625-2.212 5.954-3.905.517-2.665.475-6.508.475-6.508zm-4.024 6.709h-2.497v-6.12c0-1.29-.543-1.944-1.628-1.944-1.2 0-1.802.776-1.802 2.313v3.349h-2.484v-3.35c0-1.537-.602-2.313-1.802-2.313-1.085 0-1.628.655-1.628 1.945v6.119H4.831V8.285c0-1.29.328-2.314.987-3.07.68-.759 1.57-1.147 2.674-1.147 1.278 0 2.246.491 2.886 1.474L12 6.585l.622-1.043c.64-.983 1.608-1.474 2.886-1.474 1.104 0 1.994.388 2.674 1.146.658.757.986 1.781.986 3.07v6.305z"/></svg>

<!-- https://simpleicons.org/?q=mastodon -->

        </a>
    </div>

</div>


                    </section>
                </main>
                <footer>
                    
    <div id="taglist">
        <h6>Tags: </h6>
        <ul><li>
                    <a href="https://fightwithtools.dev/tag/node">Node</a>
                </li><li>
                    <a href="https://fightwithtools.dev/tag/wip">WiP</a>
                </li><li>
                    <a href="https://fightwithtools.dev/tag/archiving">archiving</a>
                </li><li>
                    <a href="https://fightwithtools.dev/tag/fetch">fetch</a>
                </li><li>
                    <a href="https://fightwithtools.dev/tag/user-agents">User Agents</a>
                </li><li>
                    <a href="https://fightwithtools.dev/tag/scraping">scraping</a>
                </li></ul>
    </div>

                    
                        <p>
                            <small>Hosted on <a href="https://pages.github.com" target="_blank">GitHub Pages</a> based on <a href="https://github.com/pages-themes/dinky" target="_blank">the Dinky theme</a>. <a href="https://github.com/AramZS/devblog" target="_blank">See the code</a>.</small>
                        </p>
                    
                    
                </footer>
            </div>
            <!--[if !IE]><script>fixScale(document);</script><![endif]-->
        </body>
    </html>
